<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…åˆå®¤ã‚·ã‚¹ãƒ†ãƒ  æ“ä½œç”»é¢</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="control-screen">
  <h1>ğŸ›ï¸ å¾…åˆå®¤è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ  ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h1>
  
  <!-- è¨ºå¯Ÿé †ç®¡ç†ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-header">
      ğŸ©º è¨ºå¯Ÿé †ç•ªã®ã”æ¡ˆå†…
      <button class="btn btn-info" onclick="refreshStatus()">ğŸ”„ æœ€æ–°çŠ¶æ…‹ã‚’ç¢ºèª</button>
    </div>
    <div class="card-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label>ç¬¬1è¨ºå¯Ÿå®¤</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="room1Visible" style="width: auto;">
            <span style="margin-right: 10px;">è¡¨ç¤º</span>
            <input id="room1Label" type="text" placeholder="ãƒ©ãƒ™ãƒ«" style="flex: 1;" value="ç¬¬1è¨ºå¯Ÿå®¤">
            <input id="room1Number" type="number" min="0" max="999" placeholder="ç•ªå·" style="width: 100px;" value="0">
          </div>
        </div>
        <div class="form-group">
          <label>ç¬¬2è¨ºå¯Ÿå®¤</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="room2Visible" style="width: auto;">
            <span style="margin-right: 10px;">è¡¨ç¤º</span>
            <input id="room2Label" type="text" placeholder="ãƒ©ãƒ™ãƒ«" style="flex: 1;" value="ç¬¬2è¨ºå¯Ÿå®¤">
            <input id="room2Number" type="number" min="0" max="999" placeholder="ç•ªå·" style="width: 100px;" value="0">
          </div>
        </div>
      </div>
      <button class="btn btn-success" onclick="saveStatus()">ğŸ’¾ è¨ºå¯Ÿé †ã‚’æ›´æ–°</button>
      <button class="btn btn-danger" onclick="resetStatus()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-header">
      ğŸ“¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†
      <div class="stats" id="messageStats">
        æ–‡å­—æ•°: 0/200
      </div>
    </div>
    <div class="card-content">
      <div class="form-group">
        <label>æ‚£è€…å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
        <textarea id="messageText" rows="4" placeholder="æ‚£è€…æ§˜å‘ã‘ã®ãŠçŸ¥ã‚‰ã›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚&#10;æ”¹è¡Œã‚‚å¯èƒ½ã§ã™ã€‚" maxlength="200"></textarea>
        <div style="display: flex; gap: 20px; margin-top: 10px; align-items: center;">
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="showMessage">
            ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
          </label>
        </div>
      </div>
      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆJavaScriptã§å‹•çš„ä½œæˆï¼‰ -->
      <button class="btn btn-success" onclick="saveMessage()">ğŸ’¾ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°</button>
      <button class="btn btn-danger" onclick="clearMessage()">ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆå»</button>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºè¨­å®šã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-header">
      ğŸ¯ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºè¨­å®š
    </div>
    <div class="card-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿é–“éš”ï¼ˆç§’ï¼‰</label>
          <input id="switchInterval" type="number" min="5" max="120" value="20">
          <small style="color: #666;">æ¬¡ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã¾ã§ã®æ™‚é–“ï¼ˆ5-120ç§’ï¼‰</small>
        </div>
        <div class="form-group">
          <label>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰</label>
          <input id="displayDuration" type="number" min="3" max="60" value="8">
          <small style="color: #666;">1ã¤ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹æ™‚é–“ï¼ˆ3-60ç§’ï¼‰</small>
        </div>
      </div>
      
      <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆæ–°æ©Ÿèƒ½ï¼‰ -->
      <div class="form-group">
        <label>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="displayMode" style="margin-bottom: 10px;">
          <option value="random">ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼ˆæ¯å›ç•°ãªã‚‹é †åºï¼‰</option>
          <option value="sequence">é †ç•ªè¡¨ç¤ºï¼ˆ1â†’2â†’3...â†’æœ€å¾Œâ†’1ï¼‰</option>
          <option value="order">é †ç•ªè¡¨ç¤ºï¼ˆä»–ãƒ•ã‚¡ã‚¤ãƒ«ã¨æ··åœ¨ï¼‰</option>
        </select>
        <div class="display-mode-help" style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
          <strong>ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š</strong> é£½ãã•ã›ãªã„å¤‰åŒ–ã®ã‚ã‚‹è¡¨ç¤º<br>
          <strong>é †ç•ªè¡¨ç¤ºï¼š</strong> 1ç•ªç›®ã‹ã‚‰é †ç•ªã«å…¨ã¦è¡¨ç¤ºï¼ˆå­¦ç¿’åŠ¹æœãŒé«˜ã„ï¼‰<br>
          <strong>æ··åœ¨è¡¨ç¤ºï¼š</strong> è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«æ™‚ã®é †ç•ªè¡¨ç¤º
        </div>
      </div>
      
      <!-- é †ç•ªè¡¨ç¤ºæ™‚ã®è©³ç´°è¨­å®š -->
      <div class="form-group" id="sequenceOptions" style="display: none;">
        <label>é †ç•ªè¡¨ç¤ºã®è©³ç´°è¨­å®š</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
          <div>
            <label style="font-size: 0.9rem; margin-bottom: 5px;">ç¾åœ¨ã®è¡¨ç¤ºä½ç½®</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input id="currentPosition" type="number" min="1" max="100" value="1" style="width: 80px;" readonly>
              <span style="font-size: 0.9rem;">ç•ªç›®</span>
              <button class="btn btn-info" onclick="resetSequence()" style="padding: 5px 10px; font-size: 0.8rem;">æœ€åˆã«æˆ»ã™</button>
            </div>
          </div>
          <div>
            <label style="font-size: 0.9rem; margin-bottom: 5px;">é€²è¡ŒçŠ¶æ³</label>
            <div id="sequenceProgress" style="font-size: 0.9rem; color: #666;">
              é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªä¸­...
            </div>
          </div>
        </div>
        <div class="sequence-info" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9rem; color: #666;">
          ğŸ’¡ <strong>é †ç•ªè¡¨ç¤ºã«ã¤ã„ã¦ï¼š</strong><br>
          ãƒ»ã‚³ãƒ„1ç•ªã‹ã‚‰é †ç•ªã«è¡¨ç¤ºã•ã‚Œã¾ã™<br>
          ãƒ»æœ€å¾Œã¾ã§è¡Œãã¨è‡ªå‹•çš„ã«æœ€åˆã«æˆ»ã‚Šã¾ã™<br>
          ãƒ»è¡¨ç¤ºä½ç½®ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™
        </div>
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="showTips" style="width: auto;">
          ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹
        </label>
        <small style="color: #666;">ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹TIPSãªã©ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™</small>
      </div>
      
      <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
    </div>
  </div>

  <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-header">
      ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
      <button class="btn btn-info" onclick="refreshSystemInfo()">ğŸ”„ æ›´æ–°</button>
    </div>
    <div class="card-content">
      <div class="stats" id="systemStats">
        <span>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«: <span id="fileCount">-</span>å€‹</span>
        <span>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: <span id="currentDisplayMode">-</span></span>
        <span>æœ€çµ‚æ›´æ–°: <span id="lastUpdate">-</span></span>
        <span>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: <span id="systemStatus">ç¢ºèªä¸­...</span></span>
      </div>
      <div id="systemDetails" style="margin-top: 15px; font-size: 0.9rem; color: #666;">
        ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
      </div>
      
      <!-- è¡¨ç¤ºçŠ¶æ…‹è©³ç´°ï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼‰ -->
      <div id="displayStatusDetails" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.8rem; color: #666;">
        è¡¨ç¤ºçŠ¶æ…‹ã®è©³ç´°æƒ…å ±
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="js/common.js"></script>
  <script src="js/text-utils.js"></script>
  <script src="js/control.js"></script>
  
  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šæ©Ÿèƒ½ã®è¿½åŠ JavaScript
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('displayMode').addEventListener('change', function() {
      const sequenceOptions = document.getElementById('sequenceOptions');
      if (this.value === 'sequence') {
        sequenceOptions.style.display = 'block';
        updateSequenceStatus();
      } else {
        sequenceOptions.style.display = 'none';
      }
    });
    
    // è¨­å®šèª­ã¿è¾¼ã¿ã«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’è¿½åŠ 
    const originalLoadSettings = loadSettings;
    async function loadSettings() {
      await originalLoadSettings();
      await loadDisplayModeSettings();
    }
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šã®èª­ã¿è¾¼ã¿
    async function loadDisplayModeSettings() {
      try {
        const settings = await fetchJSON('data/settings.json');
        const mental_tips = settings.files && settings.files['mental_tips.json'];
        
        if (mental_tips) {
          const displayMode = mental_tips.displayMode || 'random';
          document.getElementById('displayMode').value = displayMode;
          document.getElementById('currentDisplayMode').textContent = getDisplayModeText(displayMode);
          
          // é †ç•ªè¡¨ç¤ºã®å ´åˆã¯è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
          if (displayMode === 'sequence') {
            document.getElementById('sequenceOptions').style.display = 'block';
            updateSequenceStatus();
          }
        }
      } catch (error) {
        log('warn', 'Failed to load display mode settings:', error);
      }
    }
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
    function getDisplayModeText(mode) {
      switch (mode) {
        case 'sequence': return 'é †ç•ªè¡¨ç¤º';
        case 'order': return 'é †ç•ªè¡¨ç¤ºï¼ˆæ··åœ¨ï¼‰';
        case 'random': 
        default: return 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º';
      }
    }
    
    // è¨­å®šä¿å­˜ã«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’è¿½åŠ 
    const originalSaveSettings = saveSettings;
    async function saveSettings() {
      try {
        // åŸºæœ¬è¨­å®šã‚’ä¿å­˜
        await originalSaveSettings();
        
        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’ä¿å­˜
        await saveDisplayModeSettings();
        
      } catch (error) {
        log('error', 'Failed to save settings with display mode:', error);
        showToast('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®šã®ä¿å­˜
    async function saveDisplayModeSettings() {
      try {
        const displayMode = document.getElementById('displayMode').value;
        
        const data = {
          filename: 'mental_tips.json',
          displayMode: displayMode
        };
        
        await postJSON('php/save_display_mode.php', data);
        document.getElementById('currentDisplayMode').textContent = getDisplayModeText(displayMode);
        
        log('info', `Display mode saved: ${displayMode}`);
        
      } catch (error) {
        log('error', 'Failed to save display mode:', error);
        throw error;
      }
    }
    
    // é †ç•ªè¡¨ç¤ºã®ãƒªã‚»ãƒƒãƒˆ
    async function resetSequence() {
      if (!confirm('é †ç•ªè¡¨ç¤ºã‚’æœ€åˆã‹ã‚‰ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      try {
        await postJSON('php/reset_sequence.php', {});
        showToast('é †ç•ªè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        updateSequenceStatus();
      } catch (error) {
        log('error', 'Failed to reset sequence:', error);
        showToast('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
    
    // é †ç•ªè¡¨ç¤ºã®çŠ¶æ…‹æ›´æ–°
    async function updateSequenceStatus() {
      try {
        const response = await fetchJSON('php/get_sequence_status.php');
        
        if (response.status === 'success') {
          const status = response.data;
          document.getElementById('currentPosition').value = status.currentPosition || 1;
          document.getElementById('sequenceProgress').textContent = 
            `${status.currentPosition || 1} / ${status.totalItems || '-'} (${Math.round(((status.currentPosition || 1) / (status.totalItems || 1)) * 100)}%)`;
        }
      } catch (error) {
        log('warn', 'Failed to update sequence status:', error);
        document.getElementById('sequenceProgress').textContent = 'çŠ¶æ…‹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±æ›´æ–°ã«è¡¨ç¤ºçŠ¶æ…‹è©³ç´°ã‚’è¿½åŠ 
    const originalRefreshSystemInfo = refreshSystemInfo;
    async function refreshSystemInfo() {
      await originalRefreshSystemInfo();
      await updateDisplayStatusDetails();
    }
    
    // è¡¨ç¤ºçŠ¶æ…‹è©³ç´°ã®æ›´æ–°
    async function updateDisplayStatusDetails() {
      try {
        const response = await fetchJSON('php/get_display_status.php');
        
        if (response.status === 'success') {
          const details = response.data;
          const detailsElement = document.getElementById('displayStatusDetails');
          
          let html = '<strong>è¡¨ç¤ºçŠ¶æ…‹è©³ç´°:</strong><br>';
          html += `ãƒ¢ãƒ¼ãƒ‰: ${details.displayMode || 'unknown'}<br>`;
          
          if (details.isSequentialMode) {
            html += `é †ç•ªè¡¨ç¤º: ${details.currentFile || '-'}<br>`;
            Object.entries(details.sequentialFiles || {}).forEach(([filename, info]) => {
              html += `${filename}: ${info.progress || '-'}<br>`;
            });
          } else {
            html += `ã‚­ãƒ¥ãƒ¼: ${details.queueLength || 0}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ <br>`;
          }
          
          detailsElement.innerHTML = html;
        }
      } catch (error) {
        log('warn', 'Failed to update display status details:', error);
      }
    }
    
    // å®šæœŸçš„ãªçŠ¶æ…‹æ›´æ–°
    setInterval(async () => {
      if (document.getElementById('displayMode').value === 'sequence') {
        await updateSequenceStatus();
      }
      await updateDisplayStatusDetails();
    }, 10000); // 10ç§’é–“éš”
    
  </script>
</body>
</html>