<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè‡ªå‹•æ¤œå‡ºè¨ºæ–­</title>
    <style>
        body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 10px; border-radius: 5px; margin: 5px 0; }
        button { background: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #3498db; color: white; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè‡ªå‹•æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­</h1>
        
        <div class="info">
            <strong>æ­£ã—ã„ä»•çµ„ã¿:</strong><br>
            1. <code>php/get_files.php</code> ãŒ <code>data/contents/</code> å†…ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡º<br>
            2. ãƒ•ã‚¡ã‚¤ãƒ«åé †ã«ã‚½ãƒ¼ãƒˆã—ã¦A, B, C...ã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦<br>
            3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒA, B, Cã€ãªã©ã®çµ„ã¿åˆã‚ã›ã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’æŒ‡å®š<br>
            4. ã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«è‡ªå‹•å¤‰æ›ã—ã¦å®Ÿè¡Œ
        </div>

        <h3>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•æ¤œå‡ºãƒ†ã‚¹ãƒˆ</h3>
        <div id="fileDetectionResult"></div>
        <button onclick="testFileDetection()">ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºã‚’ãƒ†ã‚¹ãƒˆ</button>

        <h3>ğŸ”¤ ã‚¹ãƒ†ãƒƒãƒ—2: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè‡ªå‹•ç”Ÿæˆãƒ†ã‚¹ãƒˆ</h3>
        <div id="shortcutResult"></div>
        <button onclick="testShortcutGeneration()">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆ</button>

        <h3>ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè‡ªå‹•ä½œæˆãƒ†ã‚¹ãƒˆ</h3>
        <div id="playlistCreationResult"></div>
        <button onclick="testPlaylistCreation()">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè‡ªå‹•ä½œæˆã‚’ãƒ†ã‚¹ãƒˆ</button>

        <h3>ğŸ”§ ã‚¹ãƒ†ãƒƒãƒ—4: è‡ªå‹•ä¿®å¾©</h3>
        <div id="autoFixResult"></div>
        <button onclick="autoFixPlaylist()">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ä¿®å¾©</button>

        <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
        <div id="systemInfo">
            <pre id="debugInfo">è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„...</pre>
        </div>
    </div>

    <script>
        let availableFiles = [];
        let shortcutMap = {};

        // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºãƒ†ã‚¹ãƒˆ
        async function testFileDetection() {
            const resultDiv = document.getElementById('fileDetectionResult');
            resultDiv.innerHTML = '<div class="info">ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºä¸­...</div>';

            try {
                const response = await fetch('php/get_files.php', { cache: 'no-cache' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                availableFiles = data.files || [];

                let result = `<div class="success">âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºAPIæˆåŠŸ</div>`;
                result += `<div class="info">ğŸ“ æ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${availableFiles.length}</div>`;

                if (availableFiles.length > 0) {
                    result += `<table><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>è¡¨ç¤ºå</th><th>é …ç›®æ•°</th><th>ã‚µã‚¤ã‚º</th></tr>`;
                    availableFiles.forEach(file => {
                        result += `<tr>
                            <td>${file.filename}</td>
                            <td>${file.displayName}</td>
                            <td>${file.contentCount}</td>
                            <td>${file.size} bytes</td>
                        </tr>`;
                    });
                    result += `</table>`;
                } else {
                    result += `<div class="error">âŒ data/contents/ å†…ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>`;
                    result += `<div class="warning">ğŸ’¡ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:<br>
                        - mental-tips-activity.json<br>
                        - mental-tips-mindset.json<br>
                        - mental-tips-morning.json<br>
                        - mental-tips-rest.json<br>
                        - mental-tips-wellness.json</div>`;
                }

                resultDiv.innerHTML = result;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºå¤±æ•—: ${error.message}</div>
                    <div class="warning">ğŸ’¡ è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :<br>
                    - php/get_files.php ãŒå­˜åœ¨ã—ãªã„<br>
                    - PHPãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œæ¨©é™ãŒãªã„<br>
                    - data/contents/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„</div>`;
            }
        }

        // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
        function testShortcutGeneration() {
            const resultDiv = document.getElementById('shortcutResult');

            if (availableFiles.length === 0) {
                resultDiv.innerHTML = `<div class="error">âŒ å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>`;
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚½ãƒ¼ãƒˆ
            const sortedFiles = [...availableFiles].sort((a, b) => a.filename.localeCompare(b.filename));
            
            // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒãƒ—ç”Ÿæˆ
            shortcutMap = {};
            let result = `<div class="success">âœ… ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè‡ªå‹•ç”ŸæˆæˆåŠŸ</div>`;
            result += `<table><tr><th>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</th><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>è¡¨ç¤ºå</th></tr>`;

            sortedFiles.forEach((file, index) => {
                const letter = String.fromCharCode(65 + index); // A, B, C...
                shortcutMap[letter] = file.filename;
                result += `<tr>
                    <td><strong>${letter}</strong></td>
                    <td>${file.filename}</td>
                    <td>${file.displayName}</td>
                </tr>`;
            });

            result += `</table>`;
            result += `<div class="info">ğŸ’¡ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¾‹: "${Object.keys(shortcutMap).join(', ')}"</div>`;

            resultDiv.innerHTML = result;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ
        async function testPlaylistCreation() {
            const resultDiv = document.getElementById('playlistCreationResult');

            if (Object.keys(shortcutMap).length === 0) {
                resultDiv.innerHTML = `<div class="error">âŒ å…ˆã«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>`;
                return;
            }

            resultDiv.innerHTML = '<div class="info">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆä¸­...</div>';

            try {
                // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
                const playlistString = Object.keys(shortcutMap).join(', ');
                
                const playlistData = {
                    playlistString: playlistString
                };

                const response = await fetch('php/save_playlist.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(playlistData)
                });

                if (response.ok) {
                    const result = await response.json();
                    let output = `<div class="success">âœ… ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæˆåŠŸ</div>`;
                    output += `<div class="info">ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæ–‡å­—åˆ—: "${playlistString}"</div>`;
                    output += `<div class="info">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${result.data.totalFiles}</div>`;
                    output += `<div class="info">ğŸ“„ ç·é …ç›®æ•°: ${result.data.totalItems}</div>`;
                    
                    resultDiv.innerHTML = output;
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div class="error">âŒ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆå¤±æ•—: ${errorData.message}</div>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // è‡ªå‹•ä¿®å¾©
        async function autoFixPlaylist() {
            const resultDiv = document.getElementById('autoFixResult');
            resultDiv.innerHTML = '<div class="info">è‡ªå‹•ä¿®å¾©ä¸­...</div>';

            let results = [];

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
                const filesResponse = await fetch('php/get_files.php');
                if (!filesResponse.ok) {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºAPIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }

                const filesData = await filesResponse.json();
                const files = filesData.files || [];

                if (files.length === 0) {
                    throw new Error('data/contents/ å†…ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                results.push(`âœ… ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º`);

                // 2. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
                const sortedFiles = files.sort((a, b) => a.filename.localeCompare(b.filename));
                const playlistString = sortedFiles.map((_, index) => String.fromCharCode(65 + index)).join(', ');

                const playlistResponse = await fetch('php/save_playlist.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playlistString })
                });

                if (playlistResponse.ok) {
                    results.push(`âœ… ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ "${playlistString}" ã‚’ä½œæˆ`);
                } else {
                    throw new Error('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆã«å¤±æ•—');
                }

                // 3. è¨­å®šç¢ºèªãƒ»ä¿®æ­£
                const settingsResponse = await fetch('php/save_settings.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interval: 20,
                        duration: 8,
                        showTips: true
                    })
                });

                if (settingsResponse.ok) {
                    results.push(`âœ… è¨­å®šã‚’ä¿®æ­£ï¼ˆshowTips: trueï¼‰`);
                } else {
                    results.push(`âš ï¸ è¨­å®šä¿®æ­£ã«å¤±æ•—`);
                }

                let output = '<div class="success">ğŸ‰ è‡ªå‹•ä¿®å¾©å®Œäº†</div>';
                results.forEach(result => {
                    output += `<div class="info">${result}</div>`;
                });
                output += '<div class="warning">ğŸ”„ å¾…åˆå®¤ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„</div>';

                resultDiv.innerHTML = output;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è‡ªå‹•ä¿®å¾©å¤±æ•—: ${error.message}</div>`;
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const info = {
                'åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«æ•°': availableFiles.length,
                'ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒãƒ—': shortcutMap,
                'ç¾åœ¨ã®URL': window.location.href,
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ': navigator.userAgent
            };
            debugInfo.textContent = JSON.stringify(info, null, 2);
        }

        // å®šæœŸçš„ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
        setInterval(updateDebugInfo, 2000);
        updateDebugInfo();
    </script>
</body>
</html>